#!/bin/bash

if ! command -v make >/dev/null 2>&1; then
  echo "ERROR: 'make' is required but was not found in PATH." >&2
  exit 1
fi

eval "$(
  make -f - --no-print-directory print-app-vars <<'MAKE'
include .APP
print-app-vars:
	@printf 'APP=%q\n' '$(APP)'
	@printf 'IDPREF=%q\n' '$(IDPREF)'
	@printf 'BUNDLE_COPYRIGHT=%q\n' '$(BUNDLE_COPYRIGHT)'
	@printf 'SRC=%q\n' '$(SRC)'
	@printf 'BINARY=%q\n' '$(BINARY)'
MAKE
)"

echo "Deploying target: $APP"

DEP_SETTINGS=$HOME/.deployer_${APP}

if ! [ -f "$DEP_SETTINGS" ]; then
  echo "No deployment settings: $DEP_SETTINGS found, exiting..."
  exit 1
fi

. $DEP_SETTINGS
echo "Deployment settings loaded.."
cd "$(dirname "$(realpath "$0")")"/../

alert() {
curl -X POST --silent --output /dev/null https://api.telegram.org/bot${TGBOT}/sendMessage -d chat_id=${CHAT_ID} -d text="$1"
}

increase_build_number() {
  local file="BUILD"
  if [[ ! -f "$file" ]]; then
    echo "0" > "$file"
  fi

  local number
  number=$(<"$file")
  if ! [[ "$number" =~ ^[0-9]+$ ]]; then
    echo "Invalid build number in $file"
    return 1
  fi

  ((number++))
  echo "$number" > "$file"
  echo "Build number increased to $number"
}

intercept_command() {
CMM="$1"
$CMM
if [ $? -ne 0 ]; then
alert "$APP Deployer: command failed -> $CMM"
fi
}

build_and_release() {
increase_build_number
echo "Building..."
intercept_command "make release_linux"
intercept_command "make release_linux_arm64"
intercept_command "make docker_mactel_build"
intercept_command "make release_mac"
intercept_command "make docker_macarm_build"
intercept_command "make release_mac"
intercept_command "make release_win"
intercept_command "make release_win32"
echo "Build finished"
}

deploy() {
BUILD=$(<BUILD)
VERSION=$(<VERSION)
echo "Deploying version $VERSION build: $BUILD"
NEWDIR="v$VERSION-BUILD-$BUILD"

ssh "$TARGET" -p $SSHPORT "
  set -e

  if [ ! -d \"$DEPDIR\" ]; then
    mkdir -p \"$DEPDIR\"
  fi

  cd \"$DEPDIR\"

  mkdir -p \"$NEWDIR\"

  if [ -L current ] || [ -e current ]; then
    rm -f current
  fi

  ln -sfn \"$NEWDIR\" current
"

# MacOS Intel
if [ -f release/${APP}-Mac-Intel.zip ]; then
$SCP release/${APP}-Mac-Intel.zip $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Mac-Intel.zip
fi

# MacOS ARM64
if [ -f release/${APP}-Mac-arm64.zip ]; then
$SCP release/${APP}-Mac-arm64.zip $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Mac-arm64.zip
fi

# legacy for compatibility reasons
if [ -f release/${APP}-Win-x64.zip ]; then
$SCP release/${APP}-Win-x64.zip $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Win-x64.zip
fi

# Windows x86_64
if [ -f release/${APP}-Win-x86_64.zip ]; then
$SCP release/${APP}-Win-x86_64.zip $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Win-x86_64.zip
fi

# Windows x86
if [ -f release/${APP}-Win-x86.zip ]; then
$SCP release/${APP}-Win-x86.zip $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Win-x86.zip
fi

# Linux x86_64
if [ -f release/${APP}-Linux-x86_64.AppImage ]; then
$SCP release/${APP}-Linux-x86_64.AppImage $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Linux-x86_64.AppImage
fi
# Linux arm64
if [ -f release/${APP}-Linux-aarch64.AppImage ]; then
$SCP release/${APP}-Linux-aarch64.AppImage $TARGET:$DEPDIR/$NEWDIR/
rm -f release/${APP}-Linux-aarch64.AppImage
fi


git commit -am "Build $BUILD"
git push


echo "Deployment finished"
}

git pull
build_and_release
deploy

